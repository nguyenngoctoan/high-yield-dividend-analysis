version: '3.8'

# ============================================================================
# Production Docker Compose Configuration
# ============================================================================
# This configuration is optimized for production deployments with:
# - Resource limits and reservations
# - Multiple replicas for high availability
# - Nginx reverse proxy with SSL
# - Monitoring stack (Prometheus + Grafana)
# - Automated backups
# - Health checks and auto-restart
# ============================================================================

services:
  # ============================================================================
  # Backend - FastAPI Application (Multiple Replicas)
  # ============================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        - BUILD_DATE=${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        - VERSION=${VERSION:-1.0.0}
    container_name: dividend-api-${INSTANCE_ID:-1}
    restart: always
    environment:
      # Database
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}

      # API Keys
      - FMP_API_KEY=${FMP_API_KEY}
      - ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY}

      # OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI}

      # Security
      - SECRET_KEY=${SECRET_KEY}
      - SESSION_SECRET=${SESSION_SECRET}

      # Application
      - ENVIRONMENT=production
      - API_BASE_URL=${API_BASE_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}

      # Performance
      - WORKERS=4
      - PYTHONUNBUFFERED=1
    volumes:
      - ./logs:/app/logs
      - ./.env:/app/.env:ro
    networks:
      - backend-network
      - frontend-network
    deploy:
      mode: replicated
      replicas: 2  # Run 2 instances for high availability
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.dividend-api.service=backend"
      - "com.dividend-api.version=${VERSION:-1.0.0}"
      - "com.dividend-api.environment=production"

  # ============================================================================
  # Frontend - Next.js Documentation Site
  # ============================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - BUILD_DATE=${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}
        - VERSION=${VERSION:-1.0.0}
    container_name: dividend-docs
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_FRONTEND_URL=${NEXT_PUBLIC_FRONTEND_URL}
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_KEY}
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    networks:
      - frontend-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      backend:
        condition: service_healthy
    labels:
      - "com.dividend-api.service=frontend"
      - "com.dividend-api.version=${VERSION:-1.0.0}"
      - "com.dividend-api.environment=production"

  # ============================================================================
  # Redis Cache - High-Performance Caching Layer
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: dividend-redis
    restart: always
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis-data:/data
    networks:
      - backend-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    labels:
      - "com.dividend-api.service=cache"
      - "com.dividend-api.environment=production"

  # ============================================================================
  # Nginx - Reverse Proxy with SSL Termination
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: dividend-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    networks:
      - frontend-network
    depends_on:
      - backend
      - frontend
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.dividend-api.service=proxy"
      - "com.dividend-api.environment=production"

  # ============================================================================
  # Prometheus - Metrics Collection
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: dividend-prometheus
    restart: always
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - backend-network
      - monitoring-network
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.dividend-api.service=monitoring"
    profiles:
      - monitoring

  # ============================================================================
  # Grafana - Metrics Visualization
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: dividend-grafana
    restart: always
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=redis-datasource
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana/
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - monitoring-network
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.dividend-api.service=monitoring"
    profiles:
      - monitoring

  # ============================================================================
  # Backup Service - Automated Database Backups
  # ============================================================================
  backup:
    image: postgres:15-alpine
    container_name: dividend-backup
    restart: always
    environment:
      - PGHOST=${DB_HOST}
      - PGPORT=${DB_PORT:-6543}
      - PGUSER=${DB_USER:-postgres}
      - PGPASSWORD=${DB_PASSWORD}
      - PGDATABASE=${DB_NAME:-postgres}
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-0 2 * * *}  # Daily at 2 AM
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-14}
    volumes:
      - ./backups:/backups
      - ./scripts/backup_cron.sh:/usr/local/bin/backup.sh:ro
    command: >
      sh -c "echo '$BACKUP_SCHEDULE /usr/local/bin/backup.sh' | crontab - && crond -f -l 2"
    networks:
      - backend-network
    labels:
      - "com.dividend-api.service=backup"
    profiles:
      - with-backup

# ============================================================================
# Networks - Isolated Network Segmentation
# ============================================================================
networks:
  frontend-network:
    driver: bridge
    name: dividend-frontend
    ipam:
      config:
        - subnet: 172.20.0.0/24

  backend-network:
    driver: bridge
    name: dividend-backend
    internal: false  # Allow external API calls
    ipam:
      config:
        - subnet: 172.21.0.0/24

  monitoring-network:
    driver: bridge
    name: dividend-monitoring
    internal: true  # Monitoring network isolated
    ipam:
      config:
        - subnet: 172.22.0.0/24

# ============================================================================
# Volumes - Persistent Data Storage
# ============================================================================
volumes:
  redis-data:
    driver: local
    name: dividend-redis-prod
    driver_opts:
      type: none
      device: ${DATA_DIR:-./data}/redis
      o: bind

  prometheus-data:
    driver: local
    name: dividend-prometheus-prod
    driver_opts:
      type: none
      device: ${DATA_DIR:-./data}/prometheus
      o: bind

  grafana-data:
    driver: local
    name: dividend-grafana-prod
    driver_opts:
      type: none
      device: ${DATA_DIR:-./data}/grafana
      o: bind
