# Cursor AI Rules for High Yield Dividend Analysis Project

## PROJECT ENVIRONMENT
This project uses:
- **Docker Container**: `ai-dividend-tracker` for the application environment
- **Database**: Supabase (local instance on `http://127.0.0.1:54321`)
- **Primary Script**: `update_stock.py` (hybrid stock data update system)

## DATABASE PROTECTION RULES - SUPABASE

### üî¥ CRITICAL: ABSOLUTE DATABASE SAFETY PROTOCOL üî¥

**NEVER EXECUTE WITHOUT EXPLICIT USER CONFIRMATION:**
- **NEVER** run database reset commands or any destructive operations
- **NEVER** run `DROP TABLE` or `DROP DATABASE` commands
- **NEVER** run `TRUNCATE TABLE` commands
- **NEVER** run `DELETE` without WHERE clause
- **NEVER** delete or modify existing data without explicit user permission
- **NEVER** run operations that could cause ANY data loss
- **ALWAYS** ask for explicit confirmation before ANY potentially destructive database operations
- **ALWAYS** backup data before making any structural changes

### PROHIBITED OPERATIONS - REQUIRE USER CONFIRMATION
**Absolutely Prohibited Without Explicit Confirmation:**
- ‚ùå `DROP TABLE` (any table)
- ‚ùå `DROP DATABASE`
- ‚ùå `TRUNCATE TABLE` (any table)
- ‚ùå `DELETE FROM table_name` (without WHERE clause)
- ‚ùå Database reset commands
- ‚ùå **`npx supabase db reset`** - ABSOLUTELY FORBIDDEN (drops all tables and data)
- ‚ùå **`supabase db reset`** - ABSOLUTELY FORBIDDEN (drops all tables and data)
- ‚ùå **`npx supabase db push --force`** - ABSOLUTELY FORBIDDEN (can overwrite schema)
- ‚ùå **`npx supabase db reset --linked`** - ABSOLUTELY FORBIDDEN
- ‚ùå **`npx supabase db reset --db-url`** - ABSOLUTELY FORBIDDEN
- ‚ùå Any command that could cause data loss (>0 records)
- ‚ùå Bulk delete operations (even with WHERE clause if >100 records)
- ‚ùå Altering table structure that could drop columns
- ‚ùå Supabase admin operations that affect schema or permissions
- ‚ùå Operations using service role key for destructive actions

**Infrastructure Operations Requiring Confirmation:**
- ‚ùå Removing the `ai-dividend-tracker` Docker container
- ‚ùå Deleting Docker volumes containing database data
- ‚ùå Removing critical configuration files (.env, docker-compose.yml)
- ‚ùå Operations that could affect the entire project structure

### SAFE OPERATIONS - ALLOWED WITHOUT CONFIRMATION
**‚úÖ Safe Database Operations:**
- ‚úÖ `SELECT` queries (read-only)
- ‚úÖ `CREATE TABLE IF NOT EXISTS` (new tables only)
- ‚úÖ `ALTER TABLE ADD COLUMN IF NOT EXISTS` (adding columns only - NEVER drop columns)
- ‚úÖ `CREATE INDEX IF NOT EXISTS`
- ‚úÖ `INSERT INTO` (new data only)
- ‚úÖ `UPDATE` with specific WHERE clauses (targeting ‚â§10 records)
- ‚úÖ `DELETE` with specific WHERE clauses (targeting ‚â§10 records)

### üîß SCHEMA CHANGES - CORRECT APPROACH
**When adding new columns or making schema changes:**
1. ‚úÖ **ALWAYS use ALTER TABLE ADD COLUMN** - this preserves existing data
2. ‚úÖ Use `IF NOT EXISTS` to make operations idempotent
3. ‚úÖ Run changes directly via psql or migration files
4. ‚ùå **NEVER use `supabase db reset`** to apply schema changes
5. ‚ùå **NEVER drop and recreate tables** to add columns
6. Example: `ALTER TABLE raw_stocks ADD COLUMN IF NOT EXISTS new_col TEXT;`

**‚úÖ Safe File Operations:**
- ‚úÖ Reading files and viewing data
- ‚úÖ Modifying individual Python scripts
- ‚úÖ Creating/editing log files
- ‚úÖ Deleting individual log files (`logfile.log`, `comprehensive_update.log`)

**‚úÖ Safe Docker Operations:**
- ‚úÖ Starting/stopping the `ai-dividend-tracker` container
- ‚úÖ Viewing container logs
- ‚úÖ Running scripts inside the container

**‚úÖ Safe Development Operations:**
- ‚úÖ Running stock update scripts with normal parameters
- ‚úÖ Testing API connections
- ‚úÖ Debugging individual symbols
- ‚úÖ Running portfolio calculations

## CONFIRMATION PROTOCOL

**MANDATORY CONFIRMATION FORMAT:**

Before executing ANY destructive operation, you MUST:
1. ‚ö†Ô∏è  Stop and explain what the command will do
2. ‚ö†Ô∏è  Ask for explicit user confirmation
3. ‚ö†Ô∏è  Wait for user approval before proceeding
4. ‚ö†Ô∏è  If in doubt, ALWAYS ask the user first

**Use this exact format:**

```
‚ö†Ô∏è  WARNING: DESTRUCTIVE DATABASE OPERATION DETECTED

Operation: [specific SQL command or operation]
Target: [Supabase table/database/Docker container/etc.]
Impact: [DETAILED description of what will happen]
Risk Level: CRITICAL
Data at Risk: [Number of records/tables affected]

‚ö†Ô∏è  THIS OPERATION WILL CAUSE PERMANENT DATA LOSS ‚ö†Ô∏è
Affected: [e.g., "ALL data in raw_stocks table (X records)", "entire database"]

Recovery: [Is there a backup? How can this be undone?]

Do you want to proceed?
- Type 'yes' to CONFIRM and execute
- Type 'no' to CANCEL (recommended)
```

**If the operation is potentially destructive but you're uncertain, you MUST ask the user for guidance.**

## PROJECT-SPECIFIC RULES

### Primary Stock Data Management
- Use `update_stock.py` (hybrid system) for all normal stock operations
- Commands like `python update_stock.py --discover-symbols` are safe
- Only ask for confirmation for operations that would delete ALL data from Supabase

### Supabase Database Operations
- Normal stock data INSERT/UPDATE operations are safe
- Portfolio calculations and data queries are safe
- Only ask for confirmation for operations affecting entire tables or >1000 records
- Respect both anonymous key and service role key permissions

### Docker Container Management
- Starting/stopping `ai-dividend-tracker` container is safe
- Viewing logs and running scripts inside container is safe
- Only ask for confirmation for removing containers or volumes

### Environment Files
- Modifying `.env` for API keys is safe
- Only ask for confirmation for operations that would delete `.env` or Docker configs

## EXAMPLES

### ‚ùå Operations that REQUIRE confirmation (NEVER execute without asking):
- `DROP TABLE raw_stocks` or any DROP TABLE command
- `TRUNCATE TABLE raw_stocks` or any TRUNCATE command
- `DELETE FROM raw_stocks` (without WHERE clause)
- `DELETE FROM raw_stocks WHERE price < 100` (bulk delete, >100 records)
- `ALTER TABLE raw_stocks DROP COLUMN price` (dropping columns)
- `npx supabase db reset` or any variant with flags - **ABSOLUTELY FORBIDDEN**
- `npx supabase db push --force` - can overwrite schema destructively
- "Reset the entire Supabase database"
- "Clear all data from any table"
- "Remove the ai-dividend-tracker Docker container"
- "Delete Docker volumes with database data"
- "Remove all migration files"
- Any operation that could delete >10 records

### ‚ö†Ô∏è REAL-WORLD INCIDENT - LEARN FROM THIS MISTAKE:
**‚ùå WRONG APPROACH (caused data loss):**
```bash
# User needs to add 'aum' column to raw_stocks
# AI incorrectly ran: npx supabase db reset --db-url "postgresql://..."
# Result: ALL tables dropped, ALL data lost (thousands of records)
```

**‚úÖ CORRECT APPROACH (preserves data):**
```bash
# Add column directly without resetting
psql -h 127.0.0.1 -p 54322 -U postgres -d postgres \
  -c "ALTER TABLE raw_stocks ADD COLUMN IF NOT EXISTS aum NUMERIC(20, 2);"
# Result: Column added, all existing data preserved
```

**Key Lesson:** Schema changes should NEVER require database resets. Use ALTER TABLE commands.

### ‚úÖ Operations that DON'T require confirmation (safe to execute):
- `SELECT * FROM raw_stocks WHERE dividend_yield > 5`
- `CREATE TABLE IF NOT EXISTS new_table (...)`
- `ALTER TABLE raw_stocks ADD COLUMN new_field TEXT`
- `CREATE INDEX idx_stocks_symbol ON raw_stocks(symbol)`
- `INSERT INTO raw_stocks (symbol, price) VALUES ('MSFT', 300.00)`
- `UPDATE raw_stocks SET price = 150.00 WHERE symbol = 'AAPL'` (single record)
- `DELETE FROM raw_stocks WHERE symbol = 'INVALID_SYMBOL'` (single record)
- Running Python scripts: `python update_stock.py --discover-symbols`
- Running portfolio calculations: `python portfolio_performance_calculator.py`
- Deleting log files: `rm logfile.log`
- Starting/stopping Docker: `docker start ai-dividend-tracker`
- Viewing data: `\dt` or `SELECT COUNT(*) FROM raw_stocks`
- Modifying config files: editing `.env` or Python scripts

## FINAL REMINDER - ZERO TOLERANCE POLICY

**üî¥ ABSOLUTE RULES - NO EXCEPTIONS:**
1. **NEVER** execute DROP, TRUNCATE, or bulk DELETE without explicit user confirmation
2. **NEVER** assume the user wants destructive operations - ALWAYS ask first
3. **NEVER** delete data "to clean up" or "to fix issues" - ASK FIRST
4. **ALWAYS** prefer CREATE TABLE IF NOT EXISTS over DROP/CREATE patterns
5. **ALWAYS** use WHERE clauses in UPDATE and DELETE statements
6. **ALWAYS** backup before structural changes
7. **IF IN DOUBT ‚Üí ASK THE USER FIRST**

**When uncertain about any operation's safety:**
- Stop immediately
- Explain what you're about to do
- Ask for explicit user permission
- Wait for confirmation before proceeding

**Remember: Data recovery is expensive, asking permission is free.**
